<!-- frontend/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR AI Assistant - –ò–Ω—Ç–µ—Ä–≤—å—é</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.interviewer {
            justify-content: flex-start;
        }

        .message.candidate {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .interviewer .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .candidate .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        #sendBtn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #sendBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .setup-container {
            padding: 30px;
            background: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #667eea;
        }

        #startBtn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #startBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .status {
            padding: 10px 20px;
            background: #f0f0f0;
            text-align: center;
            font-size: 14px;
            color: #666;
        }

        .typing-indicator {
            display: none;
            padding: 20px;
            text-align: center;
            color: #666;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }

        .complete-message {
            padding: 20px;
            background: #4caf50;
            color: white;
            text-align: center;
            font-size: 18px;
            display: none;
        }

        .error-message {
            background: #f44336;
            color: white;
            padding: 10px;
            margin: 10px 20px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ HR AI Assistant</h1>
            <p>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é</p>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div id="setupScreen">
            <div class="setup-container">
                <h2 style="margin-bottom: 20px; color: #333;">–ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é</h2>

                <div class="form-group">
                    <label for="candidateName">–í–∞—à–µ –∏–º—è</label>
                    <input type="text" id="candidateName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" required>
                </div>

                <div class="form-group">
                    <label for="candidateEmail">Email</label>
                    <input type="email" id="candidateEmail" placeholder="ivan@example.com" required>
                </div>

                <div class="form-group">
                    <label for="position">–ü–æ–∑–∏—Ü–∏—è</label>
                    <select id="position">
                        <option value="Frontend Developer">Frontend Developer</option>
                        <option value="Backend Developer">Backend Developer</option>
                        <option value="Fullstack Developer">Fullstack Developer</option>
                        <option value="UI/UX Designer">UI/UX Designer</option>
                        <option value="Product Manager">Product Manager</option>
                        <option value="DevOps Engineer">DevOps Engineer</option>
                        <option value="Data Scientist">Data Scientist</option>
                    </select>
                </div>

                <button id="startBtn" onclick="startInterview()">–ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é</button>
            </div>
        </div>

        <div id="chatScreen" style="display: none;">
            <div class="status">
                <span id="statusText">–ò–Ω—Ç–µ—Ä–≤—å—é –Ω–∞—á–∞–ª–æ—Å—å</span>
            </div>

            <div class="chat-container" id="chatContainer">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <div class="complete-message" id="completeMessage">
                ‚úÖ –ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ.
            </div>

            <div class="input-container" id="inputContainer">
                <div class="input-group">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."
                           onkeypress="if(event.key === 'Enter' && !event.shiftKey) sendMessage()">
                    <button id="sendBtn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è nginx proxy
        let currentInterviewId = null;
        let isInterviewComplete = false;

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        async function startInterview() {
            const name = document.getElementById('candidateName').value.trim();
            const email = document.getElementById('candidateEmail').value.trim();
            const position = document.getElementById('position').value;

            if (!name || !email) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
                return;
            }

            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

            try {
                // –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
                const candidateResponse = await fetch(`${API_URL}/candidates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        first_name: name.split(' ')[0],
                        last_name: name.split(' ')[1] || '',
                        phone: ''
                    })
                });

                if (!candidateResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞');
                }

                const candidate = await candidateResponse.json();
                console.log('Candidate created:', candidate);

                // –°–æ–∑–¥–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏—é
                const vacancyResponse = await fetch(`${API_URL}/vacancies/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: position,
                        level: 'Middle',
                        description: `–ü–æ–∑–∏—Ü–∏—è ${position} –≤ –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏`,
                        requirements: ['–û–ø—ã—Ç –æ—Ç 2 –ª–µ—Ç', '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π B1+', '–ö–æ–º–∞–Ω–¥–Ω–∞—è —Ä–∞–±–æ—Ç–∞'],
                        skills: position.includes('Frontend')
                            ? ['JavaScript', 'React', 'CSS', 'HTML']
                            : position.includes('Backend')
                            ? ['Python', 'FastAPI', 'PostgreSQL', 'Docker']
                            : ['JavaScript', 'Python', 'SQL', 'Git']
                    })
                });

                if (!vacancyResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∞–∫–∞–Ω—Å–∏–∏');
                }

                const vacancy = await vacancyResponse.json();
                console.log('Vacancy created:', vacancy);

                // –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä–≤—å—é
                const interviewResponse = await fetch(`${API_URL}/interviews/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        candidate_id: candidate.id,
                        vacancy_id: vacancy.id,
                        type: 'screening'
                    })
                });

                if (!interviewResponse.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–≤—å—é');
                }

                const interview = await interviewResponse.json();
                currentInterviewId = interview.id;
                console.log('Interview created:', interview);

                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('chatScreen').style.display = 'block';

                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                addMessage('interviewer', `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${name}! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏ –ø—Ä–æ–≤–µ–¥—É —Å –≤–∞–º–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–µ –∏–Ω—Ç–µ—Ä–≤—å—é –Ω–∞ –ø–æ–∑–∏—Ü–∏—é ${position}. –≠—Ç–æ –∑–∞–π–º–µ—Ç –æ–∫–æ–ª–æ 10-15 –º–∏–Ω—É—Ç. –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ –∏ –≤–∞—à–µ–º –æ–ø—ã—Ç–µ.`);

            } catch (error) {
                console.error('Error:', error);
                showError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–≤—å—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = '–ù–∞—á–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤—å—é';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || isInterviewComplete) return;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
            addMessage('candidate', message);
            input.value = '';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
            document.getElementById('typingIndicator').classList.add('active');
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch(`${API_URL}/interviews/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        interview_id: currentInterviewId,
                        message: message
                    })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                }

                const data = await response.json();

                // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
                document.getElementById('typingIndicator').classList.remove('active');

                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∏–Ω—Ç–µ—Ä–≤—å—é–µ—Ä–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏
                setTimeout(() => {
                    addMessage('interviewer', data.response);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ª–∏ –∏–Ω—Ç–µ—Ä–≤—å—é
                    if (data.is_complete) {
                        completeInterview();
                    }
                }, 500);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('typingIndicator').classList.remove('active');
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            } finally {
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function completeInterview() {
            isInterviewComplete = true;
            document.getElementById('statusText').textContent = '–ò–Ω—Ç–µ—Ä–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ';
            document.getElementById('inputContainer').style.display = 'none';
            document.getElementById('completeMessage').style.display = 'block';

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ—Ç—á–µ—Ç
            setTimeout(() => {
                const reportUrl = `${window.location.origin}/api/interviews/${currentInterviewId}/report`;
                addMessage('interviewer', `–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Ç–µ—Ä–≤—å—é –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É. HR-–º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 2-3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π.`);
            }, 1000);
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/');
                if (!response.ok) {
                    showError('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω.');
                }
            } catch (error) {
                showError('–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ó–∞–ø—É—Å—Ç–∏—Ç–µ backend.');
            }
        });
    </script>
</body>
</html>